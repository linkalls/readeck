---

name: Readeck Release Build
run-name: ${{ gitea.actor }} release build
on:
  push:
    tags:
      - '/^[0-9.]+$/'

jobs:
  tests:
    uses: ./.forgejo/workflows/run-tests.yaml

  build:
    needs:
      - tests
    runs-on: self-hosted
    defaults:
      run:
        shell: bash
        working-directory: ${{ gitea.workspace }}
    steps:
      - uses: actions/checkout@v4

      - uses: ./.forgejo/actions/setup

      - name: Generate assets
        run: |
          make generate

      - name: Build release
        run: |
          make release-all

      - name: Build container image
        run: |
          make release-container

      - name: Copy artifacts
        run: |
          make stamp-version
          ls -l dist/
          rm -f ${HOME}/artifacts/*
          cp -p dist/* ${HOME}/artifacts/
